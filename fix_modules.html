<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- cSpell:language fr -->
    <!-- cSpell:ignore cours entreprise configur√©es v√©rification cr√©√©e existante trouv√©e manquant termin√© -->
    <title>Correction Modules Casskai</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction des Modules Casskai</h1>
        <p>Cette page va corriger les probl√®mes d'acc√®s aux pages Settings et Inventory.</p>

        <div id="status" class="step">
            <h3>√âtat: Pr√™t √† d√©marrer</h3>
            <p>Cliquez sur "D√©marrer la correction" pour commencer.</p>
        </div>

        <button id="startBtn" onclick="startFix()">D√©marrer la correction</button>
        <button id="refreshBtn" onclick="location.reload()" disabled>Rafra√Æchir la page</button>

        <div id="log" class="log" style="display: none;">
            <h4>Journal d'ex√©cution:</h4>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let logContent = document.getElementById('logContent');
        let statusDiv = document.getElementById('status');
        let startBtn = document.getElementById('startBtn');
        let refreshBtn = document.getElementById('refreshBtn');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.className = type;
            logContent.appendChild(logEntry);
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            statusDiv.className = `step ${type}`;
            statusDiv.innerHTML = `<h3>√âtat: ${message}</h3>`;
        }

        async function startFix() {
            startBtn.disabled = true;
            document.getElementById('log').style.display = 'block';
            updateStatus('Correction en cours...', 'warning');

            try {
                log('üöÄ D√©marrage de la correction des modules...');

                // √âtape 1: Activer les modules critiques
                log('üìã √âtape 1: Activation des modules critiques');
                const criticalModules = {
                    'dashboard': true,
                    'accounting': true,
                    'settings': true,
                    'inventory': true,
                    'users': true,
                    'security': true,
                    'thirdParties': true,
                    'banking': true,
                    'invoicing': true,
                    'sales': true,
                    'hr': true,
                    'projects': true,
                    'reports': true,
                    'forecasts': true,
                    'tax': true,
                    'contracts': true
                };

                localStorage.setItem('casskai_modules', JSON.stringify(criticalModules));
                log('‚úÖ Modules critiques activ√©s dans localStorage');

                // √âtape 2: Marquer l'onboarding comme termin√©
                log('üìã √âtape 2: Marquage de l\'onboarding comme termin√©');
                localStorage.setItem('casskai_onboarding_completed', 'true');
                log('‚úÖ Onboarding marqu√© comme termin√©');

                // √âtape 3: D√©finir des permissions par d√©faut
                log('üìã √âtape 3: Configuration des permissions');
                const defaultPermissions = ['*'];
                localStorage.setItem('casskai_permissions', JSON.stringify(defaultPermissions));
                log('‚úÖ Permissions configur√©es');

                // √âtape 4: Cr√©er une entreprise de test si n√©cessaire
                log('üìã √âtape 4: V√©rification de l\'entreprise');
                const currentEnterpriseId = localStorage.getItem('casskai_current_enterprise');

                if (!currentEnterpriseId) {
                    const testEnterpriseId = 'test-enterprise-' + Date.now();
                    localStorage.setItem('casskai_current_enterprise', testEnterpriseId);

                    const testEnterprises = [{
                        id: testEnterpriseId,
                        name: 'Entreprise Test',
                        country: 'FR',
                        currency: 'EUR',
                        accounting_standard: 'PCG'
                    }];
                    localStorage.setItem('casskai_enterprises', JSON.stringify(testEnterprises));
                    log('‚úÖ Entreprise de test cr√©√©e');
                } else {
                    log('‚úÖ Entreprise existante trouv√©e');
                }

                // √âtape 5: V√©rification finale
                log('üìã √âtape 5: V√©rification finale');
                const finalModules = localStorage.getItem('casskai_modules');
                const finalOnboarding = localStorage.getItem('casskai_onboarding_completed');
                const finalPermissions = localStorage.getItem('casskai_permissions');
                const finalEnterprise = localStorage.getItem('casskai_current_enterprise');

                log('üìã √âtat final:');
                log(`   Modules: ${finalModules ? '‚úÖ Configur√©' : '‚ùå Manquant'}`);
                log(`   Onboarding: ${finalOnboarding === 'true' ? '‚úÖ Termin√©' : '‚ùå Non termin√©'}`);
                log(`   Permissions: ${finalPermissions ? '‚úÖ Configur√©' : '‚ùå Manquant'}`);
                log(`   Entreprise: ${finalEnterprise ? '‚úÖ Configur√©' : '‚ùå Manquant'}`);

                updateStatus('Correction termin√©e avec succ√®s !', 'success');
                refreshBtn.disabled = false;

                log('');
                log('üéØ Prochaines √©tapes:');
                log('1. Fermez cette page');
                log('2. Retournez √† votre application Casskai');
                log('3. Rafra√Æchissez la page (F5)');
                log('4. Les pages Settings et Inventory devraient maintenant fonctionner');

            } catch (error) {
                log(`‚ùå Erreur lors de la correction: ${error.message}`, 'error');
                updateStatus('Erreur lors de la correction', 'error');
                startBtn.disabled = false;
            }
        }

        // V√©rifier l'√©tat initial
        window.addEventListener('load', function() {
            const modules = localStorage.getItem('casskai_modules');
            const onboarding = localStorage.getItem('casskai_onboarding_completed');

            if (modules && onboarding === 'true') {
                updateStatus('Configuration d√©j√† correcte', 'success');
                refreshBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
