#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get current branch
current_branch=$(git branch --show-current)

echo "ğŸ“‹ Current branch: $current_branch"

# Skip pre-push hooks for certain branches if needed
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    echo "âš ï¸  Pushing to protected branch $current_branch"
fi

# Run full test suite
echo "ğŸ§ª Running full test suite..."
npm run test:run

# Run E2E tests for critical branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    echo "ğŸ­ Running E2E tests for protected branch..."
    npm run test:e2e:ci || {
        echo "âŒ E2E tests failed!"
        exit 1
    }
fi

# Check build
echo "ğŸ—ï¸  Checking production build..."
npm run build || {
    echo "âŒ Build failed!"
    exit 1
}

# Security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high || {
    echo "âš ï¸  Security vulnerabilities found!"
    # Don't fail on audit issues, just warn
}

echo "âœ… Pre-push checks passed!"